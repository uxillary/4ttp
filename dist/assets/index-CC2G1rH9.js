import{r as st,g as it}from"./phaser-0YPJO2g1.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();var nt=st();const a=it(nt),h=["Fire","Water","Earth"],K={Fire:16735299,Water:5629605,Earth:12757370},z={Fire:1.1,Water:1,Earth:.9},T={Fire:"Thermal Protocol",Water:"Liquid Node",Earth:"Core Process"},E={Fire:"faction-fire",Water:"faction-water",Earth:"faction-earth"},ot=`<svg xmlns="http://www.w3.org/2000/svg" id="icon-fire-thermal" viewBox="0 0 128 128" role="img" aria-labelledby="t" fill="none"\r
     stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="var(--sw,6)">\r
  <title id="t">Thermal Protocol</title>\r
  <!-- outer flame -->\r
  <path d="M74 16c4 10-3 18-10 26-6 7-8 14-6 22 3-5 9-9 16-9 12 0 22 9 22 22 0 18-16 31-36 31S24 95 24 76c0-16 12-30 28-42 6-5 10-11 12-18" />\r
  <!-- inner spark -->\r
  <path d="M58 76c2-4 7-7 12-7 7 0 12 5 12 12 0 9-8 16-18 16-9 0-16-6-16-14" />\r
  <!-- protocol nodes -->\r
  <circle cx="97" cy="38" r="4"/>\r
  <circle cx="108" cy="28" r="4"/>\r
  <circle cx="88" cy="26" r="4"/>\r
  <path d="M92 28l9 8M97 38l7-10M88 26l9 2"/>\r
</svg>\r
`,rt=`<svg xmlns="http://www.w3.org/2000/svg" id="icon-water-liquid" viewBox="0 0 128 128" role="img" aria-labelledby="t" fill="none"\r
     stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="var(--sw,6)">\r
  <title id="t">Liquid Node</title>\r
  <!-- droplet -->\r
  <path d="M64 14c16 26 36 44 36 64 0 22-16 38-36 38S28 100 28 78c0-20 20-38 36-64z"/>\r
  <!-- inner lattice -->\r
  <circle cx="64" cy="78" r="10"/>\r
  <circle cx="44" cy="86" r="7"/>\r
  <circle cx="84" cy="92" r="7"/>\r
  <path d="M54 82l10-4 10 8M44 86l20-8M84 92l-10-8"/>\r
</svg>\r
`,at=`<svg xmlns="http://www.w3.org/2000/svg" id="icon-earth-core" viewBox="0 0 128 128" role="img" aria-labelledby="t" fill="none"\r
     stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="var(--sw,6)">\r
  <title id="t">Core Process</title>\r
  <!-- strata -->\r
  <path d="M16 88l18-28 22-10 22 10 18 28H16z"/>\r
  <path d="M28 88l20-14 20 14"/>\r
  <!-- core -->\r
  <circle cx="64" cy="72" r="10"/>\r
  <!-- micro traces -->\r
  <path d="M64 62v-8M54 72h-8M82 72h8M64 82v8"/>\r
</svg>\r
`,D={Fire:ot,Water:rt,Earth:at};class lt extends a.Scene{constructor(){super("Boot")}preload(){this.ensurePixelTexture(),this.ensureSquareTexture(),this.loadFactionIcons(),this.createScanlineTexture(),this.createUiTextures()}create(){this.applyIconFilters(),this.scene.launch("UI"),this.scene.start("Game")}ensurePixelTexture(){if(this.textures.exists("dot"))return;const t=this.textures.createCanvas("dot",1,1);t&&(t.context.fillStyle="#ffffff",t.context.fillRect(0,0,1,1),t.refresh())}ensureSquareTexture(){if(this.textures.exists("square8"))return;const t=this.textures.createCanvas("square8",8,8);t&&(t.context.fillStyle="#ffffff",t.context.fillRect(0,0,8,8),t.refresh())}loadFactionIcons(){Object.entries(D).forEach(([t,e])=>{const s=E[t];if(this.textures.exists(s))return;const i=this.sanitizeSvg(e),n="data:image/svg+xml;utf8,"+encodeURIComponent(i);this.load.svg(s,n)})}applyIconFilters(){Object.keys(D).forEach(t=>{const e=E[t];if(!this.textures.exists(e))return;this.textures.get(e).setFilter(a.Textures.FilterMode.LINEAR)})}sanitizeSvg(t){return t.replace(/currentColor/g,"#ffffff").replace(/var\(--sw,\s*6\)/g,"6").replace(/>\s+</g,"><").replace(/\s{2,}/g," ").trim()}createScanlineTexture(){if(this.textures.exists("overlay-scanline"))return;const t=this.add.graphics();t.setVisible(!1),t.fillStyle(16777215,.08),t.fillRect(0,0,2,1),t.generateTexture("overlay-scanline",2,2),t.destroy()}createUiTextures(){if(this.textures.exists("ui-key"))return;const t=this.add.graphics();t.setVisible(!1);const e=112,s=48;t.fillStyle(16777215,1),t.fillRoundedRect(0,0,e,s,14),t.lineStyle(2,16777215,.6),t.strokeRoundedRect(0,0,e,s,14),t.generateTexture("ui-key",e,s),t.destroy()}}const ht={Fire:["Earth"],Water:["Fire"],Earth:["Water"]};function I(o,t){return(ht[o]??[]).includes(t)}class G{constructor(t){this.groups=t}counts(){const t={};return h.forEach(e=>{t[e]=this.groups[e].getLength()}),t}weakest(){const t=this.counts();let e=h[0],s=Number.POSITIVE_INFINITY;return h.forEach(i=>{const n=t[i];n<s&&(s=n,e=i)}),e}strongest(){const t=this.counts();let e=h[0],s=Number.NEGATIVE_INFINITY;return h.forEach(i=>{const n=t[i];n>s&&(s=n,e=i)}),e}equilibrium(){return x(this.counts())}}function x(o){const t=h.map(r=>o[r]),e=t.reduce((r,l)=>r+l,0);if(e===0)return 1;const s=Math.min(...t),n=1-(Math.max(...t)-s)/e;return a.Math.Clamp(n,0,1)}class ct{constructor(t,e,s,i=320,n=12){this.width=i,this.height=n,this.graphics=t.add.graphics({x:e,y:s}).setScrollFactor(0).setDepth(40),t.events.once(a.Scenes.Events.SHUTDOWN,()=>this.graphics.destroy())}update(t,e){const s=h.reduce((r,l)=>r+t[l],0),{width:i}=this;if(this.graphics.clear(),this.graphics.fillStyle(791846,.85),this.graphics.fillRoundedRect(0,0,i,this.height,6),s<=0){this.graphics.lineStyle(1,2042948,.9),this.graphics.strokeRoundedRect(0,0,i,this.height,6);return}let n=0;h.forEach((r,l)=>{const c=t[r]/s,d=l===h.length-1?i-n:Math.max(i*c,0),y=e[r],et=l===0?{tl:6,bl:6}:l===h.length-1?{tr:6,br:6}:{tl:0,tr:0,bl:0,br:0};this.graphics.fillStyle(y,.92),this.graphics.fillRoundedRect(n,0,d,this.height,et),n+=d}),this.graphics.lineStyle(1,2042948,.9),this.graphics.strokeRoundedRect(0,0,i,this.height,6)}setVisible(t){this.graphics.setVisible(t)}}const p=18,w=190,O=64,dt={small:{quantity:6,speed:{min:60,max:140},scale:{start:3,end:0},lifespan:180},medium:{quantity:12,speed:{min:80,max:220},scale:{start:4,end:0},lifespan:240},large:{quantity:20,speed:{min:100,max:260},scale:{start:5.5,end:0},lifespan:320}};function C(o,t){o.tweens.add({targets:t,scaleX:{from:1,to:1.2},scaleY:{from:1,to:1.2},duration:160,ease:a.Math.Easing.Sine.InOut,yoyo:!0})}function M(o,t,e,s,i="medium"){const{quantity:n,speed:r,scale:l,lifespan:c}=dt[i],d=o.add.particles(t,e,"dot",{speed:r,angle:{min:0,max:360},scale:l,alpha:{start:.6,end:0,ease:"Expo.easeOut"},lifespan:c,quantity:n,tint:s,blendMode:a.BlendModes.ADD});o.time.delayedCall(c+40,()=>d.destroy())}function ut(o,t,e,s){const i=t.getChildren(),n=o.add.rectangle(o.scale.width/2,32,o.scale.width*1.2,96,2243168,.18).setScrollFactor(0).setDepth(450);o.tweens.add({targets:n,alpha:{from:.25,to:0},duration:e,onComplete:()=>n.destroy()}),i.forEach(r=>{if(!r.active)return;const l=r.alpha;r.setData("hazeMultiplier",s),r.setAlpha(.65),o.tweens.add({targets:r,alpha:l,ease:a.Math.Easing.Sine.InOut,duration:e})})}function ft(o,t,e){t.forEach(s=>{if(!s.active)return;const i=o.add.graphics({x:s.x,y:s.y}).setDepth(600);i.fillStyle(8376831,.18),i.fillCircle(0,0,s.displayWidth*.75),i.lineStyle(2,10214655,.9),i.strokeCircle(0,0,s.displayWidth*.8);const n=()=>i.setPosition(s.x,s.y);o.events.on(a.Scenes.Events.POST_UPDATE,n),o.tweens.add({targets:[i,s],alpha:{from:.8,to:.5},yoyo:!0,duration:260,repeat:Math.max(0,Math.floor(e/260)-1)}),o.time.delayedCall(e,()=>{o.events.off(a.Scenes.Events.POST_UPDATE,n),i.destroy()})})}const pt=new Set;function j(){if(typeof window>"u")return null;try{return window.localStorage}catch{return null}}function X(o){pt.add(o)}function P(o,t){const e=j();return e?(X(o),e.getItem(o)??t):t}function v(o,t){const e=j();if(e){X(o);try{e.setItem(o,t)}catch{}}}function R(o,t){const e=P(o,t?"1":"0");return e==="1"||e.toLowerCase()==="true"}function k(o,t){v(o,t?"1":"0")}function L(o,t){const e=P(o,Number.isFinite(t)?String(t):"0"),s=Number.parseFloat(e);return Number.isFinite(s)?s:t}function U(o,t){v(o,Number.isFinite(t)?String(t):"0")}const F="seed";let Q="default",W=0;function Z(o){return()=>{let t=o+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function gt(o){let t=1779033703^o.length;for(let e=0;e<o.length;e+=1)t=Math.imul(t^o.charCodeAt(e),3432918353),t=t<<13|t>>>19;return t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0}let J=Z(0);function yt(o){if(o&&o.trim().length>0)return o.trim();const t=P(F,"");if(t.trim().length>0)return t;const e=typeof crypto<"u"&&"getRandomValues"in crypto?Array.from(crypto.getRandomValues(new Uint32Array(2))).map(s=>s.toString(16)).join("").slice(0,12):Math.random().toString(36).slice(2,14);return v(F,e),e}function mt(o){const t=yt(o);Q=t,v(F,t),W=gt(t),J=Z(W)}function tt(){return J()}function N(o,t){return t<=o?o:o+tt()*(t-o)}function bt(){return Q}const St={1:500,2:8e3,3:8e3,4:1e4,5:12e3},S={slow:5e3,buff:5e3,shield:3e3},wt=11720703,V=80,xt=6,Et={1:{name:"Spawn",description:"Adds one entity of the weakest faction at the cursor."},2:{name:"Slow",description:"Reduces the strongest faction speed to 75% for 5s."},3:{name:"Buff",description:"Boosts the weakest faction speed to 125% for 5s."},4:{name:"Shield",description:"Grants 3s invulnerability to the weakest faction."},5:{name:"Nuke",description:"Removes up to six nearby entities within 80px."}};class vt{constructor(t,e,s){this.palette={...K},this.cooldownExpires={1:0,2:0,3:0,4:0,5:0},this.activeVelocity={},this.scheduled={},this.scene=t,this.groups=e,this.meter=new G(e),this.options=s}setPalette(t){this.palette=t,this.applyPalette()}cooldowns(){const t=this.scene.time.now;return{1:Math.max(0,(this.cooldownExpires[1]-t)/1e3),2:Math.max(0,(this.cooldownExpires[2]-t)/1e3),3:Math.max(0,(this.cooldownExpires[3]-t)/1e3),4:Math.max(0,(this.cooldownExpires[4]-t)/1e3),5:Math.max(0,(this.cooldownExpires[5]-t)/1e3)}}spawnWeakest(t){if(!this.consumeCooldown("1"))return!1;const e=this.meter.weakest();if(this.totalEntities()>=this.options.maxEntities)return!1;const s=this.createEntity(e,t.x,t.y);return C(this.scene,s),M(this.scene,t.x,t.y,this.palette[e],"small"),!0}slowStrongest(){if(!this.consumeCooldown("2"))return!1;const t=this.meter.strongest();return this.applyVelocityModifier("slow",t,.75,S.slow),ut(this.scene,this.groups[t],S.slow,.75),!0}buffWeakest(){if(!this.consumeCooldown("3"))return!1;const t=this.meter.weakest();return this.applyVelocityModifier("buff",t,1.25,S.buff),this.groups[t].getChildren().forEach(s=>C(this.scene,s)),!0}shieldWeakest(){if(!this.consumeCooldown("4"))return!1;const t=this.meter.weakest(),e=this.groups[t].getChildren();return e.forEach(s=>s.setData("shielded",!0)),ft(this.scene,e,S.shield),this.scheduleEffect("shield",()=>{e.forEach(s=>{s.active&&s.setData("shielded",!1)})},S.shield),!0}spawnFaction(t,e,s){return this.createEntity(t,e,s)}nuke(t){if(!this.consumeCooldown("5"))return!1;const s=this.collectSprites().map(i=>({sprite:i,dist:(i.x-t.x)**2+(i.y-t.y)**2})).filter(i=>i.dist<=V*V).sort((i,n)=>i.dist-n.dist).slice(0,xt).map(i=>i.sprite);return s.forEach(i=>i.destroy()),M(this.scene,t.x,t.y,wt,"large"),s.length>0}collectSprites(){const t=[];return Object.values(this.groups).forEach(e=>{e.getChildren().forEach(i=>{i.active&&t.push(i)})}),t}totalEntities(){return Object.values(this.groups).reduce((t,e)=>t+e.getLength(),0)}createEntity(t,e,s){const n=this.groups[t].create(e,s,E[t]);n.setDisplaySize(p,p).setTint(this.palette[t]),n.setAlpha(a.Math.FloatBetween(.82,1)),n.setData("faction",t),n.setData("shielded",!1);const r=z[t]*w;n.setData("baseSpeed",r),t==="Water"&&n.setData("wavePhase",a.Math.FloatBetween(0,Math.PI*2));const l=n.body;if(l){l.setAllowRotation(!1),l.setBounce(1,1),l.setCollideWorldBounds(!0);const c=p*.45;l.setCircle(c,(p-c*2)/2,(p-c*2)/2);const d=tt()*Math.PI*2,y=r*a.Math.FloatBetween(.9,1.15);l.velocity.setToPolar(d,y),l.maxVelocity.set(r*1.4,r*1.4)}return this.scene.events.emit("entity-created",n,t),n}consumeCooldown(t){const e=this.scene.time.now;return e<this.cooldownExpires[t]?!1:(this.cooldownExpires[t]=e+St[t],!0)}applyVelocityModifier(t,e,s,i){const n=this.activeVelocity[t];n&&this.scaleGroup(n.faction,1/n.factor),this.scaleGroup(e,s),this.activeVelocity[t]={faction:e,factor:s},this.scheduleEffect(t,()=>{this.scaleGroup(e,1/s),this.activeVelocity[t]=void 0},i)}scaleGroup(t,e){this.groups[t].getChildren().forEach(i=>{const n=i.body;n&&n.velocity.scale(e)})}applyPalette(){Object.entries(this.groups).forEach(([t,e])=>{const s=this.palette[t];e.getChildren().forEach(n=>{n.active&&n.setTint(s)})})}scheduleEffect(t,e,s){const i=this.scheduled[t];i&&i.remove(!1),this.scheduled[t]=this.scene.time.delayedCall(s,()=>{e(),this.scheduled[t]=void 0})}}const Tt={...K},Ct={Fire:16757760,Water:2656255,Earth:6997087};function g(o){return o?Ct:Tt}const B={};let A=!0;function Mt(o){if(typeof window>"u"||typeof Audio>"u")return null;let t=B[o];return t||(t=new Audio,t.preload="auto",t.muted=A,t.volume=.45,t.loop=!1,B[o]=t),t}function m(o){if(A)return;const t=Mt(o);if(!(!t||!t.src))try{t.currentTime=0,t.muted=!1,t.play().catch(()=>{})}catch{}}function _(o){A=o,Object.values(B).forEach(t=>{t&&(t.muted=o)})}const $="muted",q="colorblind",Ft={Balance:"best.balance",Domination:"best.domination"},Bt=.28,Pt=60,At=60,Y=600,f=48;class Dt extends a.Scene{constructor(){super("Game"),this.mode="Balance",this.seed="",this.uiReady=!1,this.pendingEnd=null,this.lastPayload=null,this.palette=g(!1),this.counts={Fire:0,Water:0,Earth:0},this.cooldowns={1:0,2:0,3:0,4:0,5:0},this.elapsed=0,this.paused=!1,this.ended=!1,this.hudVisible=!0,this.colorblind=!1,this.muted=!0,this.equilibriumStable=0,this.nukeUsed=!1,this.interventionsUsed=0,this.pendingSeed=null,this.handleEntityCreated=(t,e)=>{this.decorateFactionSprite(t,e,!0)},this.onCollision=(t,e)=>{const s=t,i=e,n=s.getData("faction"),r=i.getData("faction");!n||!r||n===r||s.getData("shielded")||i.getData("shielded")||(I(n,r)?this.convert(i,n):I(r,n)&&this.convert(s,r))}}init(t){t?.mode&&(this.mode=t.mode),typeof t?.seed=="string"&&t.seed.trim().length>0&&(this.pendingSeed=t.seed)}create(){this.resetState(),this.initializeSettings(),this.createBackground(),this.physics.world.setBounds(0,0,this.scale.width,this.scale.height),this.physics.world.setBoundsCollision(!0,!0,!0,!0),this.buildGroups(),this.meter=new G(this.groups),this.interventions=new vt(this,this.groups,{maxEntities:Y}),this.interventions.setPalette(this.palette),this.events.on("entity-created",this.handleEntityCreated,this),this.events.once(a.Scenes.Events.SHUTDOWN,()=>{this.events.off("entity-created",this.handleEntityCreated,this)}),this.spawnInitial(At),this.setupCollisions(),this.registerInput(),this.updateCooldowns(),this.refreshAndPublish(),this.ensureUiBinding()}createBackground(){const t=this.scale.width,e=this.scale.height;this.add.grid(t/2,e/2,t,e,O,O,660774,.24,1188667,.32).setDepth(-20).setScrollFactor(0).setStrokeStyle(1,1715007,.25),this.scanlineOverlay=this.add.tileSprite(t/2,e/2,t,e,"overlay-scanline").setScrollFactor(0).setDepth(35).setAlpha(.12),this.scanlineOverlay.setBlendMode(a.BlendModes.ADD)}ensureUiBinding(){this.scene.isActive("UI")||this.scene.launch("UI"),this.ui=this.scene.get("UI"),this.ui.isReady()?this.onUiReady():this.ui.events.once("ui-ready",()=>this.onUiReady())}onUiReady(){this.uiReady=!0,this.ui.setMode(this.mode),this.ui.setHudVisible(this.hudVisible),this.ui.setMutedAndColorblind(this.muted,this.colorblind),this.ui.hideEndPanel(),this.lastPayload&&this.ui.tick(this.lastPayload),this.ui.setCooldowns(this.cooldowns),this.pendingEnd&&(this.ui.showEndPanel(this.pendingEnd),this.pendingEnd=null)}update(t,e){const s=e/1e3;if(this.scanlineOverlay&&(this.scanlineOverlay.tilePositionY=(this.scanlineOverlay.tilePositionY-s*50)%this.scanlineOverlay.height),!this.paused&&!this.ended){this.elapsed+=s;const i=this.meter.counts();this.counts={...i};const n=x(i);n>=Bt?this.equilibriumStable+=s:this.equilibriumStable=0,this.applyFactionBehaviours(s),this.checkEndConditions(i,n),this.publishTick(i,n)}else this.publishTick(this.counts,x(this.counts));this.updateCooldowns()}restart(t=!1){const e=t?this.generateSeed():null;this.scene.restart({mode:this.mode,seed:e})}toggleMode(){const t=this.mode==="Balance"?"Domination":"Balance";this.scene.restart({mode:t,seed:null})}resetState(){this.elapsed=0,this.paused=!1,this.ended=!1,this.uiReady=!1,this.equilibriumStable=0,this.nukeUsed=!1,this.interventionsUsed=0,this.cooldowns={1:0,2:0,3:0,4:0,5:0},this.counts={Fire:0,Water:0,Earth:0},this.pendingEnd=null,this.lastPayload=null,this.physics.world.resume(),this.time.timeScale=1}initializeSettings(){mt(this.pendingSeed??void 0),this.seed=bt(),this.pendingSeed=null,this.muted=R($,this.muted),this.colorblind=R(q,this.colorblind),_(this.muted),this.palette=g(this.colorblind),this.uiReady&&this.ui.setMutedAndColorblind(this.muted,this.colorblind)}buildGroups(){const t=(()=>{const e={};return h.forEach(s=>{e[s]=this.physics.add.group({classType:a.Physics.Arcade.Image,maxSize:Y,collideWorldBounds:!0,bounceX:1,bounceY:1})}),e})();this.groups=t}spawnInitial(t){for(let e=0;e<t;e+=1){const s=h[e%h.length],i=N(f,this.scale.width-f),n=N(f,this.scale.height-f);this.spawnEntity(s,i,n)}this.refreshAndPublish()}spawnEntity(t,e,s){const i=this.interventions.spawnFaction(t,e,s);return i.setDepth(5),i}setupCollisions(){const t=Object.values(this.groups);for(let e=0;e<t.length;e+=1){const s=t[e];this.physics.add.collider(s,s,void 0,void 0,this);for(let i=e+1;i<t.length;i+=1){const n=t[i];this.physics.add.collider(s,n,this.onCollision,void 0,this)}}}convert(t,e){t.setData("faction",e),t.setData("shielded",!1),this.decorateFactionSprite(t,e,!1);const s=t.body;if(s){const i=t.getData("baseSpeed")||w;s.velocity.setLength(i*1.08)}C(this,t),M(this,t.x,t.y,this.palette[e],"small"),m("convert")}registerInput(){this.input.on("pointerdown",e=>{e.leftButtonDown()&&this.trySpawnAt(this.pointerWorld(e))});const t=this.input.keyboard;t&&(t.on("keydown-ONE",()=>this.trySpawnAt(this.pointerWorld())),t.on("keydown-TWO",()=>this.trySlowStrongest()),t.on("keydown-THREE",()=>this.tryBuffWeakest()),t.on("keydown-FOUR",()=>this.tryShieldWeakest()),t.on("keydown-FIVE",()=>this.tryNukeAt(this.pointerWorld())),t.on("keydown-M",()=>this.toggleMute()),t.on("keydown-C",()=>this.toggleColorblind()),t.on("keydown-H",()=>this.toggleHud()),t.on("keydown-SPACE",()=>this.togglePause()),t.on("keydown-R",e=>this.restart(e.shiftKey)),t.on("keydown-TAB",e=>{e.preventDefault(),this.toggleMode()}))}trySpawnAt(t){if(!this.canAct())return;this.interventions.spawnWeakest(t)&&(this.interventionsUsed+=1,m("spawn"),this.refreshAndPublish())}trySlowStrongest(){this.canAct()&&this.interventions.slowStrongest()&&(this.interventionsUsed+=1,m("slow"))}tryBuffWeakest(){this.canAct()&&this.interventions.buffWeakest()&&(this.interventionsUsed+=1,m("buff"))}tryShieldWeakest(){this.canAct()&&this.interventions.shieldWeakest()&&(this.interventionsUsed+=1,m("shield"),this.refreshAndPublish())}tryNukeAt(t){if(!this.canAct())return;this.interventions.nuke(t)&&(this.interventionsUsed+=1,this.nukeUsed=!0,m("nuke"),this.refreshAndPublish())}toggleMute(){this.muted=!this.muted,_(this.muted),k($,this.muted),this.uiReady&&this.ui.setMuted(this.muted)}toggleColorblind(){this.colorblind=!this.colorblind,k(q,this.colorblind),this.palette=g(this.colorblind),this.interventions.setPalette(this.palette),h.forEach(t=>{this.groups[t].getChildren().forEach(s=>this.decorateFactionSprite(s,t,!1))}),this.uiReady&&this.ui.setColorblind(this.colorblind),this.refreshAndPublish()}toggleHud(){this.hudVisible=!this.hudVisible,this.uiReady&&this.ui.setHudVisible(this.hudVisible)}togglePause(){this.paused=!this.paused,this.physics.world.isPaused=this.paused,this.time.timeScale=this.paused?0:1,this.refreshAndPublish()}canAct(){return!this.ended&&!this.paused}pointerWorld(t){const e=t??this.input.activePointer,s=new a.Math.Vector2;return this.cameras.main.getWorldPoint(e.x,e.y,s),s.x=a.Math.Clamp(s.x,f,this.scale.width-f),s.y=a.Math.Clamp(s.y,f,this.scale.height-f),s}checkEndConditions(t,e){if(this.ended)return;const s=h.reduce((i,n)=>i+t[n],0);this.mode==="Balance"?h.some(n=>t[n]===0)&&s>0&&this.endRun(t,e):h.some(n=>t[n]===s&&s>0)&&this.endRun(t,e)}endRun(t,e){if(this.ended)return;this.ended=!0,this.paused=!0,this.physics.world.pause(),this.time.timeScale=0;const s=this.collectAchievements(),i=this.updateBestScore(this.elapsed),n={mode:this.mode,elapsed:this.elapsed,score:this.elapsed,bestScore:i,counts:{...t},achievements:s,seed:this.seed};this.uiReady?this.ui.showEndPanel(n):this.pendingEnd=n,this.publishTick(t,e)}collectAchievements(){const t=[];return this.equilibriumStable>=Pt&&t.push("EquilibriumKeeper"),this.nukeUsed||t.push("Merciful"),this.interventionsUsed<=5&&t.push("Minimalist"),this.mode==="Domination"&&this.elapsed<120&&t.push("SwiftDominion"),t}updateBestScore(t){const e=Ft[this.mode];if(this.mode==="Balance"){const i=L(e,0);return t>i?(U(e,t),t):i>0?i:null}const s=L(e,0);return s<=0||t<s?(U(e,t),t):s>0?s:null}decorateFactionSprite(t,e,s){t.setTexture(E[e]),t.setDisplaySize(p,p),t.setOrigin(.5,.5),t.setTint(this.palette[e]),s&&t.setAlpha(a.Math.FloatBetween(.82,1)),t.setData("baseSpeed",z[e]*w),e==="Water"&&typeof t.getData("wavePhase")!="number"&&t.setData("wavePhase",a.Math.FloatBetween(0,Math.PI*2));const i=t.body;if(i){const l=t.getData("baseSpeed")||w;i.maxVelocity.set(l*1.4,l*1.4),s&&i.velocity.setLength(l)}const n=t.getData("animTween");n&&n.remove(),t.setScale(1),t.setAngle(0);const r=this.createFactionTween(t,e);t.setData("animTween",r??null),t.getData("animCleanup")||(t.once(a.GameObjects.Events.DESTROY,()=>{const l=t.getData("animTween");l&&l.remove()}),t.setData("animCleanup",!0))}createFactionTween(t,e){switch(e){case"Fire":return this.tweens.add({targets:t,duration:280,repeat:-1,ease:"Linear",keyframes:[{offset:0,scaleX:1,scaleY:1,angle:.2},{offset:.4,scaleX:1.03,scaleY:1.03,angle:-.4},{offset:.65,scaleX:.99,scaleY:.99,angle:.3},{offset:1,scaleX:1,scaleY:1,angle:0}]});case"Water":return this.tweens.add({targets:t,duration:1600,repeat:-1,ease:a.Math.Easing.Sine.InOut,keyframes:[{offset:0,scaleX:.98,scaleY:1.02,angle:-.4},{offset:.5,scaleX:1.04,scaleY:.96,angle:.4},{offset:1,scaleX:.98,scaleY:1.02,angle:-.4}]});case"Earth":return this.tweens.add({targets:t,duration:320,repeat:-1,ease:a.Math.Easing.Sine.InOut,keyframes:[{offset:0,scaleX:1,scaleY:1,angle:0},{offset:.35,scaleX:.98,scaleY:1.02,angle:1.2},{offset:.65,scaleX:1.02,scaleY:.98,angle:-1.2},{offset:1,scaleX:1,scaleY:1,angle:0}]});default:return null}}applyFactionBehaviours(t){this.groups.Fire.getChildren().forEach(n=>this.updateFireBehaviour(n,t)),this.groups.Water.getChildren().forEach(n=>this.updateWaterBehaviour(n,t)),this.groups.Earth.getChildren().forEach(n=>this.updateEarthBehaviour(n,t))}updateFireBehaviour(t,e){if(!t.active)return;const s=t.body;if(!s)return;const i=45;s.velocity.x+=a.Math.FloatBetween(-i,i)*e,s.velocity.y+=a.Math.FloatBetween(-i,i)*e,this.maintainBaseSpeed(t,.25)}updateWaterBehaviour(t,e){if(!t.active)return;const s=t.body;if(!s)return;let i=t.getData("wavePhase");typeof i!="number"&&(i=a.Math.FloatBetween(0,Math.PI*2)),i+=e*3.2,t.setData("wavePhase",i),s.velocity.rotate(Math.sin(i)*.05),this.maintainBaseSpeed(t,.08)}updateEarthBehaviour(t,e){if(!t.active)return;const s=t.body;s&&(s.velocity.scale(a.Math.Clamp(1-e*.18,.7,1)),this.maintainBaseSpeed(t,.04))}maintainBaseSpeed(t,e){const s=t.body;if(!s)return;const i=t.getData("baseSpeed")||w,n=s.velocity.length();if(n<=1){const l=a.Math.FloatBetween(0,Math.PI*2);s.velocity.setToPolar(l,i);return}const r=a.Math.Linear(n,i,e);s.velocity.setLength(r)}refreshAndPublish(){const t=this.meter.counts(),e=x(t);this.publishTick(t,e)}publishTick(t,e){this.counts={...t};const s={mode:this.mode,elapsed:this.elapsed,counts:{...t},equilibrium:e,total:h.reduce((i,n)=>i+t[n],0),paused:this.paused,ended:this.ended};this.lastPayload=s,this.uiReady&&this.ui.tick(s)}updateCooldowns(){this.cooldowns=this.interventions.cooldowns(),this.uiReady&&this.ui.setCooldowns(this.cooldowns)}generateSeed(){if(typeof crypto<"u"&&"getRandomValues"in crypto){const t=new Uint32Array(2);return crypto.getRandomValues(t),Array.from(t).map(e=>e.toString(16)).join("").slice(0,12)}return Math.random().toString(36).slice(2,14)}}const u="ui-monospace, SFMono-Regular, Menlo, Consolas, Liberation Mono, monospace",H=360,b=["1","2","3","4","5"];class It extends a.Scene{constructor(){super("UI"),this.abilityButtons={},this.hoveredAbility=null,this.tooltipKey=null,this.lastCounts={Fire:0,Water:0,Earth:0},this.muted=!0,this.colorblind=!1,this.hudVisible=!0,this.paused=!1,this.ready=!1}create(){this.createHud(),this.createAbilityBar(),this.createSettingsPanel(),this.createTooltip(),this.createEndPanel(),this.shiftKey=this.input.keyboard?.addKey(a.Input.Keyboard.KeyCodes.SHIFT),this.events.once(a.Scenes.Events.SHUTDOWN,()=>{this.ready=!1}),this.ready=!0,this.events.emit("ui-ready")}update(){if(this.shiftKey?.isDown??!1){const e=this.hoveredAbility??this.tooltipKey??b[0];e&&this.showTooltipForKey(e,!0)}else this.hoveredAbility?this.showTooltipForKey(this.hoveredAbility,!1):this.hideTooltip()}isReady(){return this.ready}setMode(t){this.modeText.setText(`Mode: ${t}`)}tick(t){this.modeText.setText(`Mode: ${t.mode}`),this.timerText.setText(`Time: ${t.elapsed.toFixed(1)}s`);const{Fire:e,Water:s,Earth:i}=t.counts;this.lastCounts.Fire=e,this.lastCounts.Water=s,this.lastCounts.Earth=i;const n=`${T.Fire.split(" ")[0]} ${e.toString().padStart(3," ")}   ${T.Water.split(" ")[0]} ${s.toString().padStart(3," ")}   ${T.Earth.split(" ")[0]} ${i.toString().padStart(3," ")}`;this.countsText.setText(n),this.equilibriumText.setText(`Equilibrium: ${(t.equilibrium*100).toFixed(0)}%`),this.balanceBar.update(this.lastCounts,g(this.colorblind)),this.paused=t.paused,this.updateSettingsDisplay(),t.ended||this.hideEndPanel()}setCooldowns(t){b.forEach(e=>{const s=this.abilityButtons[e];if(!s)return;const i=t[e];i>.05?(s.cooldown.setText(`${i.toFixed(1)}s`),s.background.setAlpha(.45)):(s.cooldown.setText(""),s.background.setAlpha(.9))})}setMuted(t){this.muted=t,this.updateSettingsDisplay()}setColorblind(t){this.colorblind=t,this.updateSettingsDisplay(),this.balanceBar.update(this.lastCounts,g(this.colorblind));const e=g(this.colorblind);b.forEach(s=>{const i=this.abilityButtons[s];if(!i)return;const n=e.Fire.toString(16).padStart(6,"0");i.label.setColor(`#${n}`)})}setHudVisible(t){this.hudVisible=t,this.hud.setVisible(t),this.balanceBar.setVisible(t),this.abilityBar.setVisible(t),this.settingsPanel.setVisible(t),t||this.hideTooltip(),this.updateSettingsDisplay()}showEndPanel(t){const e=t.bestScore!==null?t.bestScore.toFixed(1):"--";this.endTitle.setText(`${t.mode} Protocol Complete`),this.endSummary.setText(`Runtime: ${t.elapsed.toFixed(1)}s
Best: ${e}s
Seed: ${t.seed}`);const s=x(t.counts),i=[`> Final Time: ${t.elapsed.toFixed(1)}s`,`> Remaining Fire/Water/Earth: ${t.counts.Fire}/${t.counts.Water}/${t.counts.Earth}`,`> [LOG] Equilibrium maintained ${(s*100).toFixed(0)}%`];t.achievements.length?t.achievements.forEach(l=>i.push(`> [ARCHIVE] ${l}`)):i.push("> [ARCHIVE] No optional logs unlocked"),this.endLogs.setText(""),this.endPanel.setVisible(!0),this.endLogTimer&&this.endLogTimer.remove(!1);let n=0;const r=()=>{const l=this.endLogs.text?`${this.endLogs.text}
`:"";this.endLogs.setText(`${l}${i[n]}`),n+=1,n<i.length&&(this.endLogTimer=this.time.delayedCall(260,r))};r()}hideEndPanel(){this.endPanel.setVisible(!1),this.endLogTimer&&(this.endLogTimer.remove(!1),this.endLogTimer=void 0)}setMutedAndColorblind(t,e){this.muted=t,this.colorblind=e;const s=g(this.colorblind);b.forEach(i=>{const n=this.abilityButtons[i];if(!n)return;const r=s.Fire.toString(16).padStart(6,"0");n.label.setColor(`#${r}`)}),this.updateSettingsDisplay(),this.balanceBar.update(this.lastCounts,s)}createHud(){this.hud=this.add.container(24,24).setDepth(20).setScrollFactor(0);const t=this.add.rectangle(0,0,H,134,266791,.72).setOrigin(0).setStrokeStyle(2,1714758,.9),e={fontFamily:u,fontSize:"20px",color:"#cfe8ff"},s={fontFamily:u,fontSize:"16px",color:"#8fb7ff"};this.modeText=this.add.text(12,12,"Mode: Balance",e),this.timerText=this.add.text(12,38,"Time: 0.0s",e),this.countsText=this.add.text(12,64,"Therm 0   Liquid 0   Core 0",s),this.equilibriumText=this.add.text(12,90,"Equilibrium: 100%",s),this.hud.add([t,this.modeText,this.timerText,this.countsText,this.equilibriumText]),this.balanceBar=new ct(this,24,170,H-48,12)}createAbilityBar(){this.abilityBar=this.add.container(this.scale.width/2,this.scale.height-82).setDepth(25).setScrollFactor(0);const t=126;b.forEach((s,i)=>{const n=Et[s],r=this.add.container(i*t-(b.length-1)*t/2,0),l=this.add.image(0,0,"ui-key").setOrigin(.5).setAlpha(.9).setTint(1323596),c=this.add.text(-30,-6,s,{fontFamily:u,fontSize:"18px",color:"#9bdcff"}).setOrigin(.5),d=this.add.text(16,-6,n.name,{fontFamily:u,fontSize:"18px",color:"#cfe8ff"}).setOrigin(0,.5),y=this.add.text(0,16,"",{fontFamily:u,fontSize:"14px",color:"#7aa5cc"}).setOrigin(.5);r.add([l,c,d,y]),r.setSize(110,48),r.setInteractive(new a.Geom.Rectangle(-55,-24,110,48),a.Geom.Rectangle.Contains),r.on("pointerover",()=>{l.setTint(2050938),this.hoveredAbility=s,this.showTooltipForKey(s,!1)}),r.on("pointerout",()=>{l.setTint(1323596),this.hoveredAbility=null,this.shiftKey?.isDown||this.hideTooltip()}),this.abilityBar.add(r),this.abilityButtons[s]={container:r,background:l,label:d,cooldown:y,meta:n}});const e=this.add.text(0,60,"Hold Shift for ability dossiers",{fontFamily:u,fontSize:"14px",color:"#6fa4d9"}).setOrigin(.5);this.abilityBar.add(e)}createSettingsPanel(){this.settingsPanel=this.add.container(this.scale.width-210,this.scale.height-88).setDepth(25).setScrollFactor(0);const t=this.add.rectangle(0,0,220,86,267562,.78).setOrigin(.5).setStrokeStyle(2,1188666,.9);this.settingsText=this.add.text(0,0,"",{fontFamily:u,fontSize:"14px",color:"#93c3ff",align:"center"}).setOrigin(.5),this.settingsPanel.add([t,this.settingsText]),this.updateSettingsDisplay()}createTooltip(){this.tooltip=this.add.container(0,0).setDepth(40).setVisible(!1).setScrollFactor(0);const t=this.add.rectangle(0,0,280,96,464425,.94).setOrigin(.5).setStrokeStyle(2,1915479,.9);this.tooltipText=this.add.text(0,0,"",{fontFamily:u,fontSize:"16px",color:"#d1ecff",align:"center",wordWrap:{width:240}}).setOrigin(.5),this.tooltip.add([t,this.tooltipText])}createEndPanel(){this.endPanel=this.add.container(this.scale.width/2,this.scale.height/2).setDepth(200).setScrollFactor(0).setVisible(!1);const t=this.add.rectangle(0,0,560,360,465199,.92).setOrigin(.5).setStrokeStyle(2,2045529,.85),e={fontFamily:u,color:"#cfe8ff",align:"center"};this.endTitle=this.add.text(0,-140,"Protocol Complete",{...e,fontSize:"28px"}).setOrigin(.5),this.endSummary=this.add.text(0,-48,`Runtime: 0.0s
Best: --
Seed: --`,{...e,fontSize:"20px"}).setOrigin(.5),this.endLogs=this.add.text(0,36,"",{...e,fontSize:"18px",align:"left"}).setOrigin(.5),this.endFooter=this.add.text(0,140,"R: Restart | Space: Pause | M: Mute | C: Palette",{...e,fontSize:"16px",color:"#8fb7ff"}).setOrigin(.5),this.endPanel.add([t,this.endTitle,this.endSummary,this.endLogs,this.endFooter])}showTooltipForKey(t,e){const s=this.abilityButtons[t];if(!s)return;const i=s.meta;this.tooltipKey=t;const n=this.abilityBar.x+s.container.x,r=this.abilityBar.y+s.container.y;this.tooltip.setPosition(n,r-80),this.tooltipText.setText(`${i.name.toUpperCase()}
${i.description}`),this.tooltip.setVisible(this.hudVisible),e||this.tooltip.setAlpha(1)}hideTooltip(){this.tooltipKey=null,this.tooltip.setVisible(!1)}updateSettingsDisplay(){const t=this.muted?"Muted":"Audio On",e=this.colorblind?"Palette: Colorblind":"Palette: Default",s=this.hudVisible?"HUD: Visible":"HUD: Hidden",i=this.paused?"Status: Paused":"Status: Running";this.settingsText.setText(`${t}
${e}
${s}
${i}`)}}const Ot={type:a.AUTO,pixelArt:!0,backgroundColor:"#0b1220",scale:{mode:a.Scale.FIT,autoCenter:a.Scale.CENTER_BOTH,width:1280,height:720},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[lt,Dt,It],parent:"app"};new a.Game(Ot);
