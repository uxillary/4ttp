import{r as st,g as it}from"./phaser-0YPJO2g1.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();var nt=st();const r=it(nt),u=18,x=190,R=64,c=["Fire","Water","Earth"],G={Fire:16735299,Water:5629605,Earth:12757370},Y={Fire:1.1,Water:1,Earth:.9},C={Fire:"Thermal Protocol",Water:"Liquid Node",Earth:"Core Process"},T={Fire:"faction-fire",Water:"faction-water",Earth:"faction-earth"};class ot extends r.Scene{constructor(){super("Boot")}preload(){this.ensurePixelTexture(),this.ensureSquareTexture(),this.createFactionTextures(),this.createScanlineTexture(),this.createUiTextures()}create(){this.scene.launch("UI"),this.scene.start("Game")}ensurePixelTexture(){if(this.textures.exists("dot"))return;const t=this.textures.createCanvas("dot",1,1);t&&(t.context.fillStyle="#ffffff",t.context.fillRect(0,0,1,1),t.refresh())}ensureSquareTexture(){if(this.textures.exists("square8"))return;const t=this.textures.createCanvas("square8",8,8);t&&(t.context.fillStyle="#ffffff",t.context.fillRect(0,0,8,8),t.refresh())}createFactionTextures(){const t=this.add.graphics();t.setVisible(!1);const e=u*2.6,s=e/2,i=h=>{t.fillStyle(16777215,.12),t.fillCircle(s,s,h*1.8),t.fillStyle(16777215,.22),t.fillCircle(s,s,h*1.3)},d={Fire:()=>{const h=u*.7;i(h),t.fillStyle(16777215,1),t.fillTriangle(s,s-h,s-h,s+h,s+h,s+h)},Water:()=>{const h=u*.8;i(h),t.fillStyle(16777215,1),t.fillCircle(s,s,h),t.lineStyle(2,16777215,.35),t.strokeCircle(s,s,h*1.1)},Earth:()=>{const h=u*.82;i(h),t.fillStyle(16777215,1);const f=[];for(let b=0;b<6;b+=1){const O=r.Math.DegToRad(60*b-30);f.push(new r.Math.Vector2(s+Math.cos(O)*h,s+Math.sin(O)*h))}t.fillPoints(f,!0)}};c.forEach(h=>{this.textures.exists(T[h])||(t.clear(),d[h](),t.generateTexture(T[h],e,e))}),t.destroy()}createScanlineTexture(){if(this.textures.exists("overlay-scanline"))return;const t=this.add.graphics();t.setVisible(!1),t.fillStyle(16777215,.08),t.fillRect(0,0,2,1),t.generateTexture("overlay-scanline",2,2),t.destroy()}createUiTextures(){if(this.textures.exists("ui-key"))return;const t=this.add.graphics();t.setVisible(!1);const e=112,s=48;t.fillStyle(16777215,1),t.fillRoundedRect(0,0,e,s,14),t.lineStyle(2,16777215,.6),t.strokeRoundedRect(0,0,e,s,14),t.generateTexture("ui-key",e,s),t.destroy()}}const at={Fire:["Earth"],Water:["Fire"],Earth:["Water"]};function I(o,t){return(at[o]??[]).includes(t)}class j{constructor(t){this.groups=t}counts(){const t={};return c.forEach(e=>{t[e]=this.groups[e].getLength()}),t}weakest(){const t=this.counts();let e=c[0],s=Number.POSITIVE_INFINITY;return c.forEach(i=>{const n=t[i];n<s&&(s=n,e=i)}),e}strongest(){const t=this.counts();let e=c[0],s=Number.NEGATIVE_INFINITY;return c.forEach(i=>{const n=t[i];n>s&&(s=n,e=i)}),e}equilibrium(){return E(this.counts())}}function E(o){const t=c.map(a=>o[a]),e=t.reduce((a,l)=>a+l,0);if(e===0)return 1;const s=Math.min(...t),n=1-(Math.max(...t)-s)/e;return r.Math.Clamp(n,0,1)}class rt{constructor(t,e,s,i=320,n=12){this.width=i,this.height=n,this.graphics=t.add.graphics({x:e,y:s}).setScrollFactor(0).setDepth(40),t.events.once(r.Scenes.Events.SHUTDOWN,()=>this.graphics.destroy())}update(t,e){const s=c.reduce((a,l)=>a+t[l],0),{width:i}=this;if(this.graphics.clear(),this.graphics.fillStyle(791846,.85),this.graphics.fillRoundedRect(0,0,i,this.height,6),s<=0){this.graphics.lineStyle(1,2042948,.9),this.graphics.strokeRoundedRect(0,0,i,this.height,6);return}let n=0;c.forEach((a,l)=>{const d=t[a]/s,h=l===c.length-1?i-n:Math.max(i*d,0),f=e[a],b=l===0?{tl:6,bl:6}:l===c.length-1?{tr:6,br:6}:{tl:0,tr:0,bl:0,br:0};this.graphics.fillStyle(f,.92),this.graphics.fillRoundedRect(n,0,h,this.height,b),n+=h}),this.graphics.lineStyle(1,2042948,.9),this.graphics.strokeRoundedRect(0,0,i,this.height,6)}setVisible(t){this.graphics.setVisible(t)}}const lt={small:{quantity:6,speed:{min:60,max:140},scale:{start:3,end:0},lifespan:180},medium:{quantity:12,speed:{min:80,max:220},scale:{start:4,end:0},lifespan:240},large:{quantity:20,speed:{min:100,max:260},scale:{start:5.5,end:0},lifespan:320}};function F(o,t){o.tweens.add({targets:t,scaleX:{from:1,to:1.2},scaleY:{from:1,to:1.2},duration:160,ease:r.Math.Easing.Sine.InOut,yoyo:!0})}function B(o,t,e,s,i="medium"){const{quantity:n,speed:a,scale:l,lifespan:d}=lt[i],h=o.add.particles(t,e,"dot",{speed:a,angle:{min:0,max:360},scale:l,alpha:{start:.6,end:0,ease:"Expo.easeOut"},lifespan:d,quantity:n,tint:s,blendMode:r.BlendModes.ADD});o.time.delayedCall(d+40,()=>h.destroy())}function ht(o,t,e,s){const i=t.getChildren(),n=o.add.rectangle(o.scale.width/2,32,o.scale.width*1.2,96,2243168,.18).setScrollFactor(0).setDepth(450);o.tweens.add({targets:n,alpha:{from:.25,to:0},duration:e,onComplete:()=>n.destroy()}),i.forEach(a=>{if(!a.active)return;const l=a.alpha;a.setData("hazeMultiplier",s),a.setAlpha(.65),o.tweens.add({targets:a,alpha:l,ease:r.Math.Easing.Sine.InOut,duration:e})})}function ct(o,t,e){t.forEach(s=>{if(!s.active)return;const i=o.add.graphics({x:s.x,y:s.y}).setDepth(600);i.fillStyle(8376831,.18),i.fillCircle(0,0,s.displayWidth*.75),i.lineStyle(2,10214655,.9),i.strokeCircle(0,0,s.displayWidth*.8);const n=()=>i.setPosition(s.x,s.y);o.events.on(r.Scenes.Events.POST_UPDATE,n),o.tweens.add({targets:[i,s],alpha:{from:.8,to:.5},yoyo:!0,duration:260,repeat:Math.max(0,Math.floor(e/260)-1)}),o.time.delayedCall(e,()=>{o.events.off(r.Scenes.Events.POST_UPDATE,n),i.destroy()})})}const dt=new Set;function X(){if(typeof window>"u")return null;try{return window.localStorage}catch{return null}}function Q(o){dt.add(o)}function A(o,t){const e=X();return e?(Q(o),e.getItem(o)??t):t}function v(o,t){const e=X();if(e){Q(o);try{e.setItem(o,t)}catch{}}}function k(o,t){const e=A(o,t?"1":"0");return e==="1"||e.toLowerCase()==="true"}function W(o,t){v(o,t?"1":"0")}function L(o,t){const e=A(o,Number.isFinite(t)?String(t):"0"),s=Number.parseFloat(e);return Number.isFinite(s)?s:t}function U(o,t){v(o,Number.isFinite(t)?String(t):"0")}const M="seed";let Z="default",V=0;function J(o){return()=>{let t=o+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function ut(o){let t=1779033703^o.length;for(let e=0;e<o.length;e+=1)t=Math.imul(t^o.charCodeAt(e),3432918353),t=t<<13|t>>>19;return t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0}let tt=J(0);function ft(o){if(o&&o.trim().length>0)return o.trim();const t=A(M,"");if(t.trim().length>0)return t;const e=typeof crypto<"u"&&"getRandomValues"in crypto?Array.from(crypto.getRandomValues(new Uint32Array(2))).map(s=>s.toString(16)).join("").slice(0,12):Math.random().toString(36).slice(2,14);return v(M,e),e}function pt(o){const t=ft(o);Z=t,v(M,t),V=ut(t),tt=J(V)}function et(){return tt()}function N(o,t){return t<=o?o:o+et()*(t-o)}function gt(){return Z}const yt={1:500,2:8e3,3:8e3,4:1e4,5:12e3},w={slow:5e3,buff:5e3,shield:3e3},mt=11720703,_=80,St=6,bt={1:{name:"Spawn",description:"Adds one entity of the weakest faction at the cursor."},2:{name:"Slow",description:"Reduces the strongest faction speed to 75% for 5s."},3:{name:"Buff",description:"Boosts the weakest faction speed to 125% for 5s."},4:{name:"Shield",description:"Grants 3s invulnerability to the weakest faction."},5:{name:"Nuke",description:"Removes up to six nearby entities within 80px."}};class wt{constructor(t,e,s){this.palette={...G},this.cooldownExpires={1:0,2:0,3:0,4:0,5:0},this.activeVelocity={},this.scheduled={},this.scene=t,this.groups=e,this.meter=new j(e),this.options=s}setPalette(t){this.palette=t,this.applyPalette()}cooldowns(){const t=this.scene.time.now;return{1:Math.max(0,(this.cooldownExpires[1]-t)/1e3),2:Math.max(0,(this.cooldownExpires[2]-t)/1e3),3:Math.max(0,(this.cooldownExpires[3]-t)/1e3),4:Math.max(0,(this.cooldownExpires[4]-t)/1e3),5:Math.max(0,(this.cooldownExpires[5]-t)/1e3)}}spawnWeakest(t){if(!this.consumeCooldown("1"))return!1;const e=this.meter.weakest();if(this.totalEntities()>=this.options.maxEntities)return!1;const s=this.createEntity(e,t.x,t.y);return F(this.scene,s),B(this.scene,t.x,t.y,this.palette[e],"small"),!0}slowStrongest(){if(!this.consumeCooldown("2"))return!1;const t=this.meter.strongest();return this.applyVelocityModifier("slow",t,.75,w.slow),ht(this.scene,this.groups[t],w.slow,.75),!0}buffWeakest(){if(!this.consumeCooldown("3"))return!1;const t=this.meter.weakest();return this.applyVelocityModifier("buff",t,1.25,w.buff),this.groups[t].getChildren().forEach(s=>F(this.scene,s)),!0}shieldWeakest(){if(!this.consumeCooldown("4"))return!1;const t=this.meter.weakest(),e=this.groups[t].getChildren();return e.forEach(s=>s.setData("shielded",!0)),ct(this.scene,e,w.shield),this.scheduleEffect("shield",()=>{e.forEach(s=>{s.active&&s.setData("shielded",!1)})},w.shield),!0}spawnFaction(t,e,s){return this.createEntity(t,e,s)}nuke(t){if(!this.consumeCooldown("5"))return!1;const s=this.collectSprites().map(i=>({sprite:i,dist:(i.x-t.x)**2+(i.y-t.y)**2})).filter(i=>i.dist<=_*_).sort((i,n)=>i.dist-n.dist).slice(0,St).map(i=>i.sprite);return s.forEach(i=>i.destroy()),B(this.scene,t.x,t.y,mt,"large"),s.length>0}collectSprites(){const t=[];return Object.values(this.groups).forEach(e=>{e.getChildren().forEach(i=>{i.active&&t.push(i)})}),t}totalEntities(){return Object.values(this.groups).reduce((t,e)=>t+e.getLength(),0)}createEntity(t,e,s){const n=this.groups[t].create(e,s,T[t]);n.setDisplaySize(u,u).setTint(this.palette[t]),n.setAlpha(r.Math.FloatBetween(.82,1)),n.setData("faction",t),n.setData("shielded",!1);const a=Y[t]*x;n.setData("baseSpeed",a),t==="Water"&&n.setData("wavePhase",r.Math.FloatBetween(0,Math.PI*2));const l=n.body;if(l){l.setAllowRotation(!1),l.setBounce(1,1),l.setCollideWorldBounds(!0);const d=u*.45;l.setCircle(d,(u-d*2)/2,(u-d*2)/2);const h=et()*Math.PI*2,f=a*r.Math.FloatBetween(.9,1.15);l.velocity.setToPolar(h,f),l.maxVelocity.set(a*1.4,a*1.4)}return this.scene.events.emit("entity-created",n,t),n}consumeCooldown(t){const e=this.scene.time.now;return e<this.cooldownExpires[t]?!1:(this.cooldownExpires[t]=e+yt[t],!0)}applyVelocityModifier(t,e,s,i){const n=this.activeVelocity[t];n&&this.scaleGroup(n.faction,1/n.factor),this.scaleGroup(e,s),this.activeVelocity[t]={faction:e,factor:s},this.scheduleEffect(t,()=>{this.scaleGroup(e,1/s),this.activeVelocity[t]=void 0},i)}scaleGroup(t,e){this.groups[t].getChildren().forEach(i=>{const n=i.body;n&&n.velocity.scale(e)})}applyPalette(){Object.entries(this.groups).forEach(([t,e])=>{const s=this.palette[t];e.getChildren().forEach(n=>{n.active&&n.setTint(s)})})}scheduleEffect(t,e,s){const i=this.scheduled[t];i&&i.remove(!1),this.scheduled[t]=this.scene.time.delayedCall(s,()=>{e(),this.scheduled[t]=void 0})}}const xt={...G},Et={Fire:16757760,Water:2656255,Earth:6997087};function y(o){return o?Et:xt}const P={};let D=!0;function Tt(o){if(typeof window>"u"||typeof Audio>"u")return null;let t=P[o];return t||(t=new Audio,t.preload="auto",t.muted=D,t.volume=.45,t.loop=!1,P[o]=t),t}function m(o){if(D)return;const t=Tt(o);if(!(!t||!t.src))try{t.currentTime=0,t.muted=!1,t.play().catch(()=>{})}catch{}}function $(o){D=o,Object.values(P).forEach(t=>{t&&(t.muted=o)})}const q="muted",H="colorblind",vt={Balance:"best.balance",Domination:"best.domination"},Ct=.28,Ft=60,Bt=60,K=600,g=48;class Mt extends r.Scene{constructor(){super("Game"),this.mode="Balance",this.seed="",this.uiReady=!1,this.pendingEnd=null,this.lastPayload=null,this.palette=y(!1),this.counts={Fire:0,Water:0,Earth:0},this.cooldowns={1:0,2:0,3:0,4:0,5:0},this.elapsed=0,this.paused=!1,this.ended=!1,this.hudVisible=!0,this.colorblind=!1,this.muted=!0,this.equilibriumStable=0,this.nukeUsed=!1,this.interventionsUsed=0,this.pendingSeed=null,this.handleEntityCreated=(t,e)=>{this.decorateFactionSprite(t,e,!0)},this.onCollision=(t,e)=>{const s=t,i=e,n=s.getData("faction"),a=i.getData("faction");!n||!a||n===a||s.getData("shielded")||i.getData("shielded")||(I(n,a)?this.convert(i,n):I(a,n)&&this.convert(s,a))}}init(t){t?.mode&&(this.mode=t.mode),typeof t?.seed=="string"&&t.seed.trim().length>0&&(this.pendingSeed=t.seed)}create(){this.resetState(),this.initializeSettings(),this.createBackground(),this.physics.world.setBounds(0,0,this.scale.width,this.scale.height),this.physics.world.setBoundsCollision(!0,!0,!0,!0),this.buildGroups(),this.meter=new j(this.groups),this.interventions=new wt(this,this.groups,{maxEntities:K}),this.interventions.setPalette(this.palette),this.events.on("entity-created",this.handleEntityCreated,this),this.events.once(r.Scenes.Events.SHUTDOWN,()=>{this.events.off("entity-created",this.handleEntityCreated,this)}),this.spawnInitial(Bt),this.setupCollisions(),this.registerInput(),this.updateCooldowns(),this.refreshAndPublish(),this.ensureUiBinding()}createBackground(){const t=this.scale.width,e=this.scale.height;this.add.grid(t/2,e/2,t,e,R,R,660774,.24,1188667,.32).setDepth(-20).setScrollFactor(0).setStrokeStyle(1,1715007,.25),this.scanlineOverlay=this.add.tileSprite(t/2,e/2,t,e,"overlay-scanline").setScrollFactor(0).setDepth(35).setAlpha(.12),this.scanlineOverlay.setBlendMode(r.BlendModes.ADD)}ensureUiBinding(){this.scene.isActive("UI")||this.scene.launch("UI"),this.ui=this.scene.get("UI"),this.ui.isReady()?this.onUiReady():this.ui.events.once("ui-ready",()=>this.onUiReady())}onUiReady(){this.uiReady=!0,this.ui.setMode(this.mode),this.ui.setHudVisible(this.hudVisible),this.ui.setMutedAndColorblind(this.muted,this.colorblind),this.ui.hideEndPanel(),this.lastPayload&&this.ui.tick(this.lastPayload),this.ui.setCooldowns(this.cooldowns),this.pendingEnd&&(this.ui.showEndPanel(this.pendingEnd),this.pendingEnd=null)}update(t,e){const s=e/1e3;if(this.scanlineOverlay&&(this.scanlineOverlay.tilePositionY=(this.scanlineOverlay.tilePositionY-s*50)%this.scanlineOverlay.height),!this.paused&&!this.ended){this.elapsed+=s;const i=this.meter.counts();this.counts={...i};const n=E(i);n>=Ct?this.equilibriumStable+=s:this.equilibriumStable=0,this.applyFactionBehaviours(s),this.checkEndConditions(i,n),this.publishTick(i,n)}else this.publishTick(this.counts,E(this.counts));this.updateCooldowns()}restart(t=!1){const e=t?this.generateSeed():null;this.scene.restart({mode:this.mode,seed:e})}toggleMode(){const t=this.mode==="Balance"?"Domination":"Balance";this.scene.restart({mode:t,seed:null})}resetState(){this.elapsed=0,this.paused=!1,this.ended=!1,this.uiReady=!1,this.equilibriumStable=0,this.nukeUsed=!1,this.interventionsUsed=0,this.cooldowns={1:0,2:0,3:0,4:0,5:0},this.counts={Fire:0,Water:0,Earth:0},this.pendingEnd=null,this.lastPayload=null,this.physics.world.resume(),this.time.timeScale=1}initializeSettings(){pt(this.pendingSeed??void 0),this.seed=gt(),this.pendingSeed=null,this.muted=k(q,this.muted),this.colorblind=k(H,this.colorblind),$(this.muted),this.palette=y(this.colorblind),this.uiReady&&this.ui.setMutedAndColorblind(this.muted,this.colorblind)}buildGroups(){const t=(()=>{const e={};return c.forEach(s=>{e[s]=this.physics.add.group({classType:r.Physics.Arcade.Image,maxSize:K,collideWorldBounds:!0,bounceX:1,bounceY:1})}),e})();this.groups=t}spawnInitial(t){for(let e=0;e<t;e+=1){const s=c[e%c.length],i=N(g,this.scale.width-g),n=N(g,this.scale.height-g);this.spawnEntity(s,i,n)}this.refreshAndPublish()}spawnEntity(t,e,s){const i=this.interventions.spawnFaction(t,e,s);return i.setDepth(5),i}setupCollisions(){const t=Object.values(this.groups);for(let e=0;e<t.length;e+=1){const s=t[e];this.physics.add.collider(s,s,void 0,void 0,this);for(let i=e+1;i<t.length;i+=1){const n=t[i];this.physics.add.collider(s,n,this.onCollision,void 0,this)}}}convert(t,e){t.setData("faction",e),t.setData("shielded",!1),this.decorateFactionSprite(t,e,!1);const s=t.body;if(s){const i=t.getData("baseSpeed")||x;s.velocity.setLength(i*1.08)}F(this,t),B(this,t.x,t.y,this.palette[e],"small"),m("convert")}registerInput(){this.input.on("pointerdown",e=>{e.leftButtonDown()&&this.trySpawnAt(this.pointerWorld(e))});const t=this.input.keyboard;t&&(t.on("keydown-ONE",()=>this.trySpawnAt(this.pointerWorld())),t.on("keydown-TWO",()=>this.trySlowStrongest()),t.on("keydown-THREE",()=>this.tryBuffWeakest()),t.on("keydown-FOUR",()=>this.tryShieldWeakest()),t.on("keydown-FIVE",()=>this.tryNukeAt(this.pointerWorld())),t.on("keydown-M",()=>this.toggleMute()),t.on("keydown-C",()=>this.toggleColorblind()),t.on("keydown-H",()=>this.toggleHud()),t.on("keydown-SPACE",()=>this.togglePause()),t.on("keydown-R",e=>this.restart(e.shiftKey)),t.on("keydown-TAB",e=>{e.preventDefault(),this.toggleMode()}))}trySpawnAt(t){if(!this.canAct())return;this.interventions.spawnWeakest(t)&&(this.interventionsUsed+=1,m("spawn"),this.refreshAndPublish())}trySlowStrongest(){this.canAct()&&this.interventions.slowStrongest()&&(this.interventionsUsed+=1,m("slow"))}tryBuffWeakest(){this.canAct()&&this.interventions.buffWeakest()&&(this.interventionsUsed+=1,m("buff"))}tryShieldWeakest(){this.canAct()&&this.interventions.shieldWeakest()&&(this.interventionsUsed+=1,m("shield"),this.refreshAndPublish())}tryNukeAt(t){if(!this.canAct())return;this.interventions.nuke(t)&&(this.interventionsUsed+=1,this.nukeUsed=!0,m("nuke"),this.refreshAndPublish())}toggleMute(){this.muted=!this.muted,$(this.muted),W(q,this.muted),this.uiReady&&this.ui.setMuted(this.muted)}toggleColorblind(){this.colorblind=!this.colorblind,W(H,this.colorblind),this.palette=y(this.colorblind),this.interventions.setPalette(this.palette),c.forEach(t=>{this.groups[t].getChildren().forEach(s=>this.decorateFactionSprite(s,t,!1))}),this.uiReady&&this.ui.setColorblind(this.colorblind),this.refreshAndPublish()}toggleHud(){this.hudVisible=!this.hudVisible,this.uiReady&&this.ui.setHudVisible(this.hudVisible)}togglePause(){this.paused=!this.paused,this.physics.world.isPaused=this.paused,this.time.timeScale=this.paused?0:1,this.refreshAndPublish()}canAct(){return!this.ended&&!this.paused}pointerWorld(t){const e=t??this.input.activePointer,s=new r.Math.Vector2;return this.cameras.main.getWorldPoint(e.x,e.y,s),s.x=r.Math.Clamp(s.x,g,this.scale.width-g),s.y=r.Math.Clamp(s.y,g,this.scale.height-g),s}checkEndConditions(t,e){if(this.ended)return;const s=c.reduce((i,n)=>i+t[n],0);this.mode==="Balance"?c.some(n=>t[n]===0)&&s>0&&this.endRun(t,e):c.some(n=>t[n]===s&&s>0)&&this.endRun(t,e)}endRun(t,e){if(this.ended)return;this.ended=!0,this.paused=!0,this.physics.world.pause(),this.time.timeScale=0;const s=this.collectAchievements(),i=this.updateBestScore(this.elapsed),n={mode:this.mode,elapsed:this.elapsed,score:this.elapsed,bestScore:i,counts:{...t},achievements:s,seed:this.seed};this.uiReady?this.ui.showEndPanel(n):this.pendingEnd=n,this.publishTick(t,e)}collectAchievements(){const t=[];return this.equilibriumStable>=Ft&&t.push("EquilibriumKeeper"),this.nukeUsed||t.push("Merciful"),this.interventionsUsed<=5&&t.push("Minimalist"),this.mode==="Domination"&&this.elapsed<120&&t.push("SwiftDominion"),t}updateBestScore(t){const e=vt[this.mode];if(this.mode==="Balance"){const i=L(e,0);return t>i?(U(e,t),t):i>0?i:null}const s=L(e,0);return s<=0||t<s?(U(e,t),t):s>0?s:null}decorateFactionSprite(t,e,s){t.setTexture(T[e]),t.setDisplaySize(u,u),t.setOrigin(.5,.5),t.setTint(this.palette[e]),s&&t.setAlpha(r.Math.FloatBetween(.82,1)),t.setData("baseSpeed",Y[e]*x),e==="Water"&&typeof t.getData("wavePhase")!="number"&&t.setData("wavePhase",r.Math.FloatBetween(0,Math.PI*2));const i=t.body;if(i){const l=t.getData("baseSpeed")||x;i.maxVelocity.set(l*1.4,l*1.4),s&&i.velocity.setLength(l)}const n=t.getData("animTween");n&&n.remove(),t.setScale(1),t.setAngle(0);const a=this.createFactionTween(t,e);t.setData("animTween",a??null),t.getData("animCleanup")||(t.once(r.GameObjects.Events.DESTROY,()=>{const l=t.getData("animTween");l&&l.remove()}),t.setData("animCleanup",!0))}createFactionTween(t,e){switch(e){case"Fire":return this.tweens.add({targets:t,duration:480,scale:{from:1,to:1.12},yoyo:!0,repeat:-1,ease:r.Math.Easing.Sine.InOut});case"Water":return this.tweens.add({targets:t,duration:900,scaleX:{from:.98,to:1.04},scaleY:{from:1.02,to:.96},yoyo:!0,repeat:-1,ease:r.Math.Easing.Sine.InOut});case"Earth":return this.tweens.add({targets:t,duration:1200,scaleY:{from:1,to:.94},yoyo:!0,repeat:-1,ease:r.Math.Easing.Quadratic.InOut});default:return null}}applyFactionBehaviours(t){this.groups.Fire.getChildren().forEach(n=>this.updateFireBehaviour(n,t)),this.groups.Water.getChildren().forEach(n=>this.updateWaterBehaviour(n,t)),this.groups.Earth.getChildren().forEach(n=>this.updateEarthBehaviour(n,t))}updateFireBehaviour(t,e){if(!t.active)return;const s=t.body;if(!s)return;const i=45;s.velocity.x+=r.Math.FloatBetween(-i,i)*e,s.velocity.y+=r.Math.FloatBetween(-i,i)*e,this.maintainBaseSpeed(t,.25)}updateWaterBehaviour(t,e){if(!t.active)return;const s=t.body;if(!s)return;let i=t.getData("wavePhase");typeof i!="number"&&(i=r.Math.FloatBetween(0,Math.PI*2)),i+=e*3.2,t.setData("wavePhase",i),s.velocity.rotate(Math.sin(i)*.05),this.maintainBaseSpeed(t,.08)}updateEarthBehaviour(t,e){if(!t.active)return;const s=t.body;s&&(s.velocity.scale(r.Math.Clamp(1-e*.18,.7,1)),this.maintainBaseSpeed(t,.04))}maintainBaseSpeed(t,e){const s=t.body;if(!s)return;const i=t.getData("baseSpeed")||x,n=s.velocity.length();if(n<=1){const l=r.Math.FloatBetween(0,Math.PI*2);s.velocity.setToPolar(l,i);return}const a=r.Math.Linear(n,i,e);s.velocity.setLength(a)}refreshAndPublish(){const t=this.meter.counts(),e=E(t);this.publishTick(t,e)}publishTick(t,e){this.counts={...t};const s={mode:this.mode,elapsed:this.elapsed,counts:{...t},equilibrium:e,total:c.reduce((i,n)=>i+t[n],0),paused:this.paused,ended:this.ended};this.lastPayload=s,this.uiReady&&this.ui.tick(s)}updateCooldowns(){this.cooldowns=this.interventions.cooldowns(),this.uiReady&&this.ui.setCooldowns(this.cooldowns)}generateSeed(){if(typeof crypto<"u"&&"getRandomValues"in crypto){const t=new Uint32Array(2);return crypto.getRandomValues(t),Array.from(t).map(e=>e.toString(16)).join("").slice(0,12)}return Math.random().toString(36).slice(2,14)}}const p="ui-monospace, SFMono-Regular, Menlo, Consolas, Liberation Mono, monospace",z=360,S=["1","2","3","4","5"];class Pt extends r.Scene{constructor(){super("UI"),this.abilityButtons={},this.hoveredAbility=null,this.tooltipKey=null,this.lastCounts={Fire:0,Water:0,Earth:0},this.muted=!0,this.colorblind=!1,this.hudVisible=!0,this.paused=!1,this.ready=!1}create(){this.createHud(),this.createAbilityBar(),this.createSettingsPanel(),this.createTooltip(),this.createEndPanel(),this.shiftKey=this.input.keyboard?.addKey(r.Input.Keyboard.KeyCodes.SHIFT),this.events.once(r.Scenes.Events.SHUTDOWN,()=>{this.ready=!1}),this.ready=!0,this.events.emit("ui-ready")}update(){if(this.shiftKey?.isDown??!1){const e=this.hoveredAbility??this.tooltipKey??S[0];e&&this.showTooltipForKey(e,!0)}else this.hoveredAbility?this.showTooltipForKey(this.hoveredAbility,!1):this.hideTooltip()}isReady(){return this.ready}setMode(t){this.modeText.setText(`Mode: ${t}`)}tick(t){this.modeText.setText(`Mode: ${t.mode}`),this.timerText.setText(`Time: ${t.elapsed.toFixed(1)}s`);const{Fire:e,Water:s,Earth:i}=t.counts;this.lastCounts.Fire=e,this.lastCounts.Water=s,this.lastCounts.Earth=i;const n=`${C.Fire.split(" ")[0]} ${e.toString().padStart(3," ")}   ${C.Water.split(" ")[0]} ${s.toString().padStart(3," ")}   ${C.Earth.split(" ")[0]} ${i.toString().padStart(3," ")}`;this.countsText.setText(n),this.equilibriumText.setText(`Equilibrium: ${(t.equilibrium*100).toFixed(0)}%`),this.balanceBar.update(this.lastCounts,y(this.colorblind)),this.paused=t.paused,this.updateSettingsDisplay(),t.ended||this.hideEndPanel()}setCooldowns(t){S.forEach(e=>{const s=this.abilityButtons[e];if(!s)return;const i=t[e];i>.05?(s.cooldown.setText(`${i.toFixed(1)}s`),s.background.setAlpha(.45)):(s.cooldown.setText(""),s.background.setAlpha(.9))})}setMuted(t){this.muted=t,this.updateSettingsDisplay()}setColorblind(t){this.colorblind=t,this.updateSettingsDisplay(),this.balanceBar.update(this.lastCounts,y(this.colorblind));const e=y(this.colorblind);S.forEach(s=>{const i=this.abilityButtons[s];if(!i)return;const n=e.Fire.toString(16).padStart(6,"0");i.label.setColor(`#${n}`)})}setHudVisible(t){this.hudVisible=t,this.hud.setVisible(t),this.balanceBar.setVisible(t),this.abilityBar.setVisible(t),this.settingsPanel.setVisible(t),t||this.hideTooltip(),this.updateSettingsDisplay()}showEndPanel(t){const e=t.bestScore!==null?t.bestScore.toFixed(1):"--";this.endTitle.setText(`${t.mode} Protocol Complete`),this.endSummary.setText(`Runtime: ${t.elapsed.toFixed(1)}s
Best: ${e}s
Seed: ${t.seed}`);const s=E(t.counts),i=[`> Final Time: ${t.elapsed.toFixed(1)}s`,`> Remaining Fire/Water/Earth: ${t.counts.Fire}/${t.counts.Water}/${t.counts.Earth}`,`> [LOG] Equilibrium maintained ${(s*100).toFixed(0)}%`];t.achievements.length?t.achievements.forEach(l=>i.push(`> [ARCHIVE] ${l}`)):i.push("> [ARCHIVE] No optional logs unlocked"),this.endLogs.setText(""),this.endPanel.setVisible(!0),this.endLogTimer&&this.endLogTimer.remove(!1);let n=0;const a=()=>{const l=this.endLogs.text?`${this.endLogs.text}
`:"";this.endLogs.setText(`${l}${i[n]}`),n+=1,n<i.length&&(this.endLogTimer=this.time.delayedCall(260,a))};a()}hideEndPanel(){this.endPanel.setVisible(!1),this.endLogTimer&&(this.endLogTimer.remove(!1),this.endLogTimer=void 0)}setMutedAndColorblind(t,e){this.muted=t,this.colorblind=e;const s=y(this.colorblind);S.forEach(i=>{const n=this.abilityButtons[i];if(!n)return;const a=s.Fire.toString(16).padStart(6,"0");n.label.setColor(`#${a}`)}),this.updateSettingsDisplay(),this.balanceBar.update(this.lastCounts,s)}createHud(){this.hud=this.add.container(24,24).setDepth(20).setScrollFactor(0);const t=this.add.rectangle(0,0,z,134,266791,.72).setOrigin(0).setStrokeStyle(2,1714758,.9),e={fontFamily:p,fontSize:"20px",color:"#cfe8ff"},s={fontFamily:p,fontSize:"16px",color:"#8fb7ff"};this.modeText=this.add.text(12,12,"Mode: Balance",e),this.timerText=this.add.text(12,38,"Time: 0.0s",e),this.countsText=this.add.text(12,64,"Therm 0   Liquid 0   Core 0",s),this.equilibriumText=this.add.text(12,90,"Equilibrium: 100%",s),this.hud.add([t,this.modeText,this.timerText,this.countsText,this.equilibriumText]),this.balanceBar=new rt(this,24,170,z-48,12)}createAbilityBar(){this.abilityBar=this.add.container(this.scale.width/2,this.scale.height-82).setDepth(25).setScrollFactor(0);const t=126;S.forEach((s,i)=>{const n=bt[s],a=this.add.container(i*t-(S.length-1)*t/2,0),l=this.add.image(0,0,"ui-key").setOrigin(.5).setAlpha(.9).setTint(1323596),d=this.add.text(-30,-6,s,{fontFamily:p,fontSize:"18px",color:"#9bdcff"}).setOrigin(.5),h=this.add.text(16,-6,n.name,{fontFamily:p,fontSize:"18px",color:"#cfe8ff"}).setOrigin(0,.5),f=this.add.text(0,16,"",{fontFamily:p,fontSize:"14px",color:"#7aa5cc"}).setOrigin(.5);a.add([l,d,h,f]),a.setSize(110,48),a.setInteractive(new r.Geom.Rectangle(-55,-24,110,48),r.Geom.Rectangle.Contains),a.on("pointerover",()=>{l.setTint(2050938),this.hoveredAbility=s,this.showTooltipForKey(s,!1)}),a.on("pointerout",()=>{l.setTint(1323596),this.hoveredAbility=null,this.shiftKey?.isDown||this.hideTooltip()}),this.abilityBar.add(a),this.abilityButtons[s]={container:a,background:l,label:h,cooldown:f,meta:n}});const e=this.add.text(0,60,"Hold Shift for ability dossiers",{fontFamily:p,fontSize:"14px",color:"#6fa4d9"}).setOrigin(.5);this.abilityBar.add(e)}createSettingsPanel(){this.settingsPanel=this.add.container(this.scale.width-210,this.scale.height-88).setDepth(25).setScrollFactor(0);const t=this.add.rectangle(0,0,220,86,267562,.78).setOrigin(.5).setStrokeStyle(2,1188666,.9);this.settingsText=this.add.text(0,0,"",{fontFamily:p,fontSize:"14px",color:"#93c3ff",align:"center"}).setOrigin(.5),this.settingsPanel.add([t,this.settingsText]),this.updateSettingsDisplay()}createTooltip(){this.tooltip=this.add.container(0,0).setDepth(40).setVisible(!1).setScrollFactor(0);const t=this.add.rectangle(0,0,280,96,464425,.94).setOrigin(.5).setStrokeStyle(2,1915479,.9);this.tooltipText=this.add.text(0,0,"",{fontFamily:p,fontSize:"16px",color:"#d1ecff",align:"center",wordWrap:{width:240}}).setOrigin(.5),this.tooltip.add([t,this.tooltipText])}createEndPanel(){this.endPanel=this.add.container(this.scale.width/2,this.scale.height/2).setDepth(200).setScrollFactor(0).setVisible(!1);const t=this.add.rectangle(0,0,560,360,465199,.92).setOrigin(.5).setStrokeStyle(2,2045529,.85),e={fontFamily:p,color:"#cfe8ff",align:"center"};this.endTitle=this.add.text(0,-140,"Protocol Complete",{...e,fontSize:"28px"}).setOrigin(.5),this.endSummary=this.add.text(0,-48,`Runtime: 0.0s
Best: --
Seed: --`,{...e,fontSize:"20px"}).setOrigin(.5),this.endLogs=this.add.text(0,36,"",{...e,fontSize:"18px",align:"left"}).setOrigin(.5),this.endFooter=this.add.text(0,140,"R: Restart | Space: Pause | M: Mute | C: Palette",{...e,fontSize:"16px",color:"#8fb7ff"}).setOrigin(.5),this.endPanel.add([t,this.endTitle,this.endSummary,this.endLogs,this.endFooter])}showTooltipForKey(t,e){const s=this.abilityButtons[t];if(!s)return;const i=s.meta;this.tooltipKey=t;const n=this.abilityBar.x+s.container.x,a=this.abilityBar.y+s.container.y;this.tooltip.setPosition(n,a-80),this.tooltipText.setText(`${i.name.toUpperCase()}
${i.description}`),this.tooltip.setVisible(this.hudVisible),e||this.tooltip.setAlpha(1)}hideTooltip(){this.tooltipKey=null,this.tooltip.setVisible(!1)}updateSettingsDisplay(){const t=this.muted?"Muted":"Audio On",e=this.colorblind?"Palette: Colorblind":"Palette: Default",s=this.hudVisible?"HUD: Visible":"HUD: Hidden",i=this.paused?"Status: Paused":"Status: Running";this.settingsText.setText(`${t}
${e}
${s}
${i}`)}}const At={type:r.AUTO,pixelArt:!0,backgroundColor:"#0b1220",scale:{mode:r.Scale.FIT,autoCenter:r.Scale.CENTER_BOTH,width:1280,height:720},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[ot,Mt,Pt],parent:"app"};new r.Game(At);
